"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
const logger_1 = require("@sap-ux/logger");
const flp_1 = require("../base/flp");
const adp_tooling_1 = require("@sap-ux/adp-tooling");
/**
 * Initialize the preview for an adaptation project.
 *
 * @param rootProject reference to the project
 * @param config configuration from the ui5.yaml
 * @param flp FlpSandbox instance
 * @param logger logger instance
 */
function initAdp(rootProject, config, flp, logger) {
    return __awaiter(this, void 0, void 0, function* () {
        const files = yield rootProject.byGlob('/manifest.appdescr_variant');
        if (files.length === 1) {
            const adp = new adp_tooling_1.AdpPreview(config, rootProject, logger);
            const layer = yield adp.init(JSON.parse(yield files[0].getString()));
            flp.config.rta = { layer };
            yield flp.init(adp.descriptor.manifest, adp.descriptor.name, adp.resources);
            flp.router.use(adp.descriptor.url, adp.proxy.bind(adp));
        }
        else {
            throw new Error('ADP configured but no manifest.appdescr_variant found.');
        }
    });
}
/**
 * Create the router that is to be exposed as UI5 middleware.
 *
 * @param param0 parameters provider by UI5
 * @param param0.resources reference to resources
 * @param param0.options options and configurations from the ui5.yaml
 * @param param0.middlewareUtil additional UI5 CLI utilities
 * @param logger logger instance
 * @returns a router
 */
function createRouter({ resources, options, middlewareUtil }, logger) {
    var _a, _b;
    return __awaiter(this, void 0, void 0, function* () {
        // setting defaults
        const config = (_a = options.configuration) !== null && _a !== void 0 ? _a : {};
        (_b = config.flp) !== null && _b !== void 0 ? _b : (config.flp = {});
        // configure the FLP sandbox based on information from the manifest
        const flp = new flp_1.FlpSandbox(config.flp, resources.rootProject, middlewareUtil, logger);
        if (config.adp) {
            yield initAdp(resources.rootProject, config.adp, flp, logger);
        }
        else {
            const files = yield resources.rootProject.byGlob('/manifest.json');
            if (files.length === 1) {
                yield flp.init(JSON.parse(yield files[0].getString()));
            }
            else {
                throw new Error('No manifest.json found.');
            }
        }
        return flp.router;
    });
}
/**
 * Exporting the middleware for usage in the UI5 tooling.
 *
 * @param params middleware configuration
 * @returns a promise for the request handler
 */
module.exports = (params) => __awaiter(void 0, void 0, void 0, function* () {
    var _a;
    const logger = new logger_1.ToolsLogger({
        transports: [new logger_1.UI5ToolingTransport({ moduleName: 'preview-middleware' })],
        logLevel: ((_a = params.options.configuration) === null || _a === void 0 ? void 0 : _a.debug) ? logger_1.LogLevel.Debug : logger_1.LogLevel.Info
    });
    try {
        return yield createRouter(params, logger);
    }
    catch (error) {
        logger.error('Could not start preview-middleware.');
        logger.error(error.message);
        throw error;
    }
});
//# sourceMappingURL=middleware.js.map